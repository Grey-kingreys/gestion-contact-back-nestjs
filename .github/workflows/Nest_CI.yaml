name: NestJS CI/CD

on:
  push:
    branches: [ "master" ]

jobs:
  test-build:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configurer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: Installer les dépendances
        run: npm install
      
      - name: Lancer les tests
        run: npm test -- --passWithNoTests
      
      - name: Construire le projet
        run: npm run build

  deploy:
    name: Deploy to Render via API
    needs: test-build
    runs-on: ubuntu-latest
    steps:
      - name: Déclencher le déploiement via l'API Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          curl -X POST \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "clearCache": false
            }'
      
      - name: Vérifier le statut du déploiement
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          # Attendre un peu que le déploiement commence
          sleep 10
          
          # Récupérer le statut du dernier déploiement
          response=$(curl -s \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys?limit=1" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $RENDER_API_KEY")
          
          echo "Statut du déploiement:"
          echo $response | jq '.[0] | {id: .id, status: .status, createdAt: .createdAt}'