name: NestJS CI/CD

on:
  push:
    branches: [ "master" ]

jobs:
  test-build:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configurer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: Installer les dépendances
        run: npm install
      
      - name: Lancer les tests si disponibles
        run: |
          if [ -f "jest.config.js" ] || [ -f "jest.config.ts" ]; then
            npm test -- --passWithNoTests
          else
            echo "Aucune configuration Jest trouvée, skip des tests"
          fi
      
      - name: Vérifier la construction
        run: npm run build
      
      - name: Linter (optionnel)
        run: npm run lint || echo "Aucun script lint configuré"

  deploy:
    name: Deploy to Render
    needs: test-build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Configurer Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Installer les dépendances et builder
        run: |
          npm ci
          npm run build
      
      - name: Déployer sur Render
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          curl -X POST "$RENDER_DEPLOY_HOOK_URL"